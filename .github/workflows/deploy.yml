name: Frontend Game CI/CD via Serve & PM2

# è§¦å‘æ¡ä»¶ï¼šå½“ä»£ç æ¨é€åˆ° main åˆ†æ”¯æ—¶è‡ªåŠ¨è¿è¡Œ
on:
  push:
    branches:
      - main
  # å…è®¸åœ¨ GitHub Actions ç•Œé¢æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  # ------------------------------------
  # 1. æŒç»­é›†æˆ (CI) - æ„å»ºé¡¹ç›®
  # ------------------------------------
  build:
    name: ğŸ—ï¸ Build Vue Project
    runs-on: ubuntu-latest

    steps:
      - name: â¬‡ï¸ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ› ï¸ Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20' # æ¨èä½¿ç”¨ LTS ç‰ˆæœ¬
          cache: 'npm'       # ç¼“å­˜ä¾èµ–ä»¥åŠ é€Ÿæ„å»º

      - name: ğŸ“¦ Install Dependencies
        run: npm install

      - name: âš™ï¸ Build Vue Project
        # å‡è®¾æ‚¨çš„æ„å»ºå‘½ä»¤æ˜¯ npm run build
        run: npm run build

      - name: â¬†ï¸ Upload Build Artifact (dist)
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist-artifact
          path: dev/ # é»˜è®¤ Vue/Vite çš„æ„å»ºè¾“å‡ºç›®å½•
          retention-days: 1 # ä¿ç•™ä¸€å¤©å³å¯
          
  # ------------------------------------
  # 2. æŒç»­éƒ¨ç½² (CD) - éƒ¨ç½²ä¸æœåŠ¡é‡å¯
  # ------------------------------------
  deploy:
    name: ğŸš€ Deploy & Restart Service
    needs: build # ä¾èµ–äº build ä»»åŠ¡æˆåŠŸ
    runs-on: ubuntu-latest
    
    # ç¡®ä¿ secrets å­˜åœ¨
    env:
      SSH_USER: ${{ secrets.REMOTE_USER }}
      SSH_HOST: ${{ secrets.REMOTE_HOST }}
      SSH_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
      DEPLOY_PATH: ${{ secrets.REMOTE_TARGET }}

    steps:
      - name: ğŸ” Verify Deployment Variables
        run: |
          echo "REMOTE_USER is set to: ${{ secrets.REMOTE_USER }}"
          echo "REMOTE_HOST is set to: ${{ secrets.REMOTE_HOST }}"
          echo "REMOTE_TARGET is set to: ${{ secrets.REMOTE_TARGET }}"
          # æ³¨æ„ï¼šç»å¯¹ä¸è¦æ‰“å° ${{ secrets.SSH_PRIVATE_KEY }}ï¼

      - name: â¬‡ï¸ Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist-artifact
          # ä¸‹è½½åˆ°å½“å‰å·¥ä½œç›®å½•

      - name: ğŸ“¤ Deploy Files via SCP (rsync)
        # ä½¿ç”¨ rsync ç¡®ä¿åªæœ‰æ›´æ”¹çš„æ–‡ä»¶è¢«ä¼ è¾“ï¼Œå¹¶åˆ é™¤æ—§æ–‡ä»¶
        uses: easingthemes/ssh-deploy@main
        with:
          SSH_PRIVATE_KEY: ${{ env.SSH_KEY }}
          REMOTE_HOST: ${{ env.SSH_HOST }}
          REMOTE_USER: ${{ env.SSH_USER }}
          
          # SOURCE æ˜¯å½“å‰å·¥ä½œç›®å½• (å³ä¸‹è½½çš„ dist ç›®å½•)
          SOURCE: '.' 
          # TARGET æ˜¯æ‚¨åœ¨ Secrets ä¸­è®¾å®šçš„æœåŠ¡å™¨è·¯å¾„
          TARGET: ${{ env.DEPLOY_PATH }}
          
          # -avz: å½’æ¡£æ¨¡å¼ï¼Œè¯¦ç»†è¾“å‡ºï¼Œå‹ç¼©ä¼ è¾“ï¼› --delete: åˆ é™¤ç›®æ ‡è·¯å¾„ä¸­æºè·¯å¾„æ²¡æœ‰çš„æ–‡ä»¶
          ARGS: '-avz --delete'

      - name: ğŸ”„ Restart Static Server (via PM2/Serve)
        # ä½¿ç”¨ appleboy/ssh-action æ¥æ‰§è¡Œè¿œç¨‹å‘½ä»¤
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.SSH_HOST }}
          username: ${{ env.SSH_USER }}
          key: ${{ env.SSH_KEY }}
          
          # åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œçš„å‘½ä»¤
          script: |
            echo "--- Navigating to deployment path ---"
            cd ${{ env.DEPLOY_PATH }}
            
            echo "--- Stopping and deleting old PM2 process ---"
            # å°è¯•åœæ­¢å’Œåˆ é™¤æ—§è¿›ç¨‹ï¼Œå¿½ç•¥å¤±è´¥ï¼ˆå¦‚æœè¿›ç¨‹ä¸å­˜åœ¨ï¼‰
            pm2 stop my-vue-game || true 
            pm2 delete my-vue-game || true
            
            echo "--- Starting new 'serve' process on port 3421 ---"
            # å¯åŠ¨ serve æœåŠ¡:
            # -s: å¯åŠ¨é™æ€æ–‡ä»¶æœåŠ¡
            # --single: å¯ç”¨å•é¡µåº”ç”¨æ¨¡å¼ (ç”¨äº Vue Router history mode)
            # -l 3421: ç›‘å¬ 3421 ç«¯å£
            pm2 start serve --name "my-vue-game" -- -s --single -l 3421 ./
            
            echo "--- Saving PM2 status ---"
            pm2 save
            
            echo "Deployment and Service Restart Complete."
